---
title: "563project"
author: "Yan Liu"
date: "11/9/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

Read data
```{r}
library(tidyverse)

data_whole<-read_csv("diabetes.csv")

```

Split data
Split the data into a training (70% of the data) and test set (30% of the data)
```{r, message=FALSE, warning=FALSE}
library(caret)
library(rsample)
set.seed(14)
index <- initial_split(data_whole,
                       prop = 0.7)
train <- training(index)
test <- testing(index)
```

Data Plots

```{r}
library(corrplot)
res <- cor(data_whole)

#Plot the correlation matrix values by cluster
corrplot(res, type = "upper", order = "hclust",
         tl.col = "black", tl.cex = 0.5)
```


```{r,fig1, fig.height = 20, fig.width = 20}
library(PerformanceAnalytics)
chart.Correlation(data_whole, histogram = TRUE, method = "pearson")
```

```{r}
train <- train %>% 
  mutate(Outcome = as.factor(Outcome))
test <- test %>% 
  mutate(Outcome = as.factor(Outcome))
glm<- glm(Outcome~.,train,family="binomial")
summary(glm)
par(mfrow=c(2,2))
plot(glm)
car::vif(glm)# a VIF value larger than 5 or 10 indicates a problematic amount of multicollinearity, No multicollinearity

glm_prob <- predict(glm, test,type = "response")
glm_pred <- rep(0, length(glm_prob))
glm_pred[glm_prob > 0.5] <- 1
mean(glm_pred != test$Outcome)

#yhat_glm<-predict(glm,test)
#RMSE_glm<-sqrt(mean((test$shares - exp(yhat_lm))^2))
```

```{r}
#backward selection after log transformation
library(leaps)
backward<- regsubsets(Outcome~., train, nvmax = 9, method = "backward")
backward_summary<-summary(backward)

#backward_summary[["which"]][size, ]
par(mfrow=c(1,3))
plot(backward_summary$cp, xlab = "Size", ylab = "backward Cp", type = "l")
plot(backward_summary$bic, xlab = "Size", ylab = "backward bic", type = "l")
plot(backward_summary$adjr2, xlab = "Size", ylab = "backward adjR2", type = "l")

coef(backward, which.min(backward_summary$cp))
coef(backward, which.max(backward_summary$adjr2))

#get best subset of the specified size with min cp.
sub <- backward_summary$which[which.min(backward_summary$cp), ]
test_back <- test[, sub]
# Create test model matrix, predcition, test error
glm_prob <- predict(glm, test,type = "response")
glm_pred <- rep(0, length(glm_prob))
glm_pred[glm_prob > 0.5] <- 1
mean(glm_pred != test$Outcome)



test_model <- model.matrix(log(shares)~ ., data = lmNewTest3)
model <- test_model[, sub]
yhat_back<-model %*% coef(backward, which.min(backward_summary$cp))
RMSE_back<-sqrt(mean((test$shares - exp(yhat_back))^2))
```

```{r}
library(rpart)
library(rpart.plot)
tree_class <- rpart(
  Outcome ~ .,
  data = train,
  method = 'class',
  parms = list(split = "information"),
  control = rpart.control(
    xval = 10,
    minbucket = 2,
    cp = 0
  )
)
printcp(tree_class)
cp <- tree_class$cptable
tree_class_final <- prune(tree_class, cp = cp[3,1])
rpart.plot(tree_class_final)
```
